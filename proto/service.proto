syntax = "proto3";

package mtfs;

import "dirnode.proto";

option go_package = "velda.io/mtfs/pkg/proto";

enum ClaimStatus {
  CLAIM_STATUS_UNSPECIFIED = 0;             // Unspecified claim status
  CLAIM_STATUS_EXCLUSIVE_WRITE_GRANTED = 1; // Exclusive write access granted
  CLAIM_STATUS_LOCK_READ_GRANTED = 2;       // Read lock granted
  CLAIM_STATUS_EXCLUSIVE_WRITE_REVOKED = 3; // Write lock revoked
  CLAIM_STATUS_LOCK_READ_REVOKED = 4;       // Read lock revoked
}

message OperationRequest {
  bytes cookie = 1; // Cookie for the request
  int64 seq_id = 2; // Sequence ID of the request
  oneof operation {
    // Request to create a directory.
    MkdirRequest mkdir = 3;

    LookupRequest lookup = 4;    // Request to look up a file or directory
    GetAttrRequest get_attr = 5; // Request to get file or directory attributes
    MknodRequest mknod = 6;   // Request to create a node (file, symlink, etc.)
    RmdirRequest rmdir = 7;   // Request to remove a directory
    UnlinkRequest unlink = 8; // Request to remove a file
    SymlinkRequest symlink = 9;    // Request to create a symlink
    ReadlinkRequest readlink = 10; // Request to read a symlink
    SetAttrRequest set_attr =
        11; // Request to set attributes of a file or directory
    ScanDirectoryRequest scan_dir = 12;

    // File ops
    OpenRequest open = 13;     // Request to open a file
    ReadRequest read = 14;     // Request to read from a file
    WriteRequest write = 15;   // Request to write to a file
    CloseRequest close = 16;   // Request to close a file
    CreateRequest create = 17; // Request to create a file

    MountRequest mount = 18; // Request to mount a filesystem
    UmountRequest umount = 19; // Request to unmount a filesystem
  }
}

message ErrorResponse {
  // unix error code
  int32 code = 2;
  string detail_msg = 1;
}

message OperationResponse {
  // Sequence ID of the request, 0 if it's notification from the server
  int64 seq_id = 1;
  bytes cookie = 2; // Cookie for the identity of the inode.
  ErrorResponse error = 3; // Error response if the operation failed
  oneof response {
    // Notifications from the server.
    ClaimUpdateServerRequest claim_update = 4; // Claim update request

    MkdirResponse mkdir = 5;
    LookupResponse lookup = 6;
    GetAttrResponse get_attr = 7;
    MknodResponse mknod = 8;
    RmdirResponse rmdir = 9;        // Response to remove a directory
    UnlinkResponse unlink = 10;      // Response to remove a file
    SymlinkResponse symlink = 11;   // Response to create a symlink
    ReadlinkResponse readlink = 12; // Response to read a symlink
    SetAttrResponse set_attr =
        13; // Response to set attributes of a file or directory
    ScanDirectoryResponse scan_dir = 14; // Response to scan a directory

    OpenResponse open = 15;     // Response to open a file
    ReadResponse read = 16;     // Response to read from a file
    WriteResponse write = 17;   // Response to write to a file
    CloseResponse close = 18;   // Response to close a file
    CreateResponse create = 19; // Response to create a file

    MountResponse mount = 20; // Response to mount a filesystem
    UmountResponse umount = 21; // Response to unmount a filesystem
  }
}

message MkdirRequest {
  string name = 1; // Name of the directory to create
  FileStat stat = 2;
}

message MkdirResponse {
  // Identifier of the created directory.
  bytes cookie = 1;
  FileStat stat = 2;
}

message LookupRequest {
  string name = 1; // Name of the file or directory to look up
}

message LookupResponse {
  // Identifier of the looked-up file or directory.
  bytes cookie = 1;
  FileStat stat = 2;     // Node information for the looked-up file or directory
  ClaimStatus claim = 3; // Claim status of the looked-up file or directory
}

message GetAttrRequest {}

message GetAttrResponse {
  FileStat stat = 1; // Statistics of the file or directory
  ClaimStatus claim_update = 2;
}

message MknodRequest {
  string name = 1;   // Name of the node to create
  FileStat stat = 2; // Statistics for the node
}

message MknodResponse {
  bytes cookie = 1;  // Identifier of the created node
  FileStat stat = 2; // Statistics of the created node
}

message RmdirRequest {
  string name = 1; // Name of the directory to remove
}

message RmdirResponse {}

message UnlinkRequest {
  string name = 1; // Name of the file to remove
}

message UnlinkResponse {}

message SymlinkRequest {
  string name = 1;   // Name of the symlink to create
  string target = 2; // Target of the symlink
  FileStat stat = 3; // Statistics for the symlink
}

message SymlinkResponse {
  bytes cookie = 1;  // Identifier of the created symlink
  FileStat stat = 2; // Statistics of the created symlink
}

message ReadlinkRequest {}

message ReadlinkResponse {
  bytes target = 1; // Target of the symlink
}

message SetAttrRequest {
  FileStat stat = 1; // New statistics for the file or directory
}

message SetAttrResponse {
  FileStat stat = 1; // Updated statistics of the file or directory
}

message ScanDirectoryRequest {
  bytes token =
      1; // Token for the directory to scan. Empty for scan from the beginning.
}

message ScanDirectoryResponse {
  repeated DirEntry entries = 1; // List of directory entries
  bytes offset_token = 2;        // Token for the next offset
}

message CreateRequest {
  string name = 1;   // Name of the file to create
  uint32 flags = 2;  // Flags for creating the file
  FileStat stat = 3; // Statistics for the file
}
message CreateResponse {
  bytes cookie = 1;      // Identifier of the created file
  bytes file_handle = 2; // File handle for the created file
  FileStat stat = 3;     // Statistics of the created file
  ClaimStatus claim = 4; // Claim status of the created file
}

message OpenRequest {
  uint32 flags = 2; // Flags for opening the file
}

message OpenResponse {
  ClaimStatus claim = 1; // Claim status of the opened file
  bytes file_handle = 2; // File handle for the opened file
}

message ReadRequest {
  bytes file_handle = 1; // File handle for the file to read
  int64 offset = 2;      // Offset to start reading from
  uint32 size = 3;       // Size of the data to read
}

message ReadResponse {
  bytes data = 1; // Data read from the file
}

message WriteRequest {
  bytes file_handle = 1; // File handle for the file to write to
  int64 offset = 2;      // Offset to start writing at
  bytes data = 3;        // Data to write to the file
}
message WriteResponse {
  uint32 size = 1; // Number of bytes written
}

message CloseRequest {
  bytes file_handle = 1; // File handle for the file to close
}

message CloseResponse {
  ClaimStatus claim = 1; // Claim status after closing the file
}
message ClaimUpdateServerRequest {
  ClaimStatus status = 1; // Status of the claim update
}
message UmountRequest {
}
message UmountResponse {
}

message MountRequest {
  // Volume name.
  string volume = 1;
}

message MountResponse {
  bytes cookie = 1;      // Cookie for the mount point
  FileStat stat = 2;     // Statistics of the mount point
  ClaimStatus claim = 3; // Claim status of the mount point
}

service MtfsService {
  // Creates a working connection to the MTFS service.
  rpc Serve(stream OperationRequest) returns (stream OperationResponse) {}
}